name: Deploy PROD website

on:
  workflow_dispatch:
    inputs:
      invalidate_chache:
        description: 'Invalider le cache'
        required: true
        default: 'false'
        type: boolean
        
  push:
    branches:
      - main
    paths:
      - public/**
  #pull_request:  

jobs:
  check_html:
    name: Check HTML
    runs-on: ubuntu-latest
    steps:
      - name: HTML5Validator
        uses: Cyb3r-Jak3/html5validator-action@master
        with:
          root: public/
          css: true

  check:
    name: Broken Link Check
    runs-on: ubuntu-latest
    steps:
      - name: Broken Link Check
        uses: technote-space/broken-link-checker-action@v2

  deploy:
    name: DÃ©ploiement vers AWS
    needs: [check, check_html]
    runs-on: ubuntu-latest
    steps:
    - name: Building envirnment
      uses: actions/checkout@master
    - name: Push to S3
      uses: jakejarvis/s3-sync-action@master
      with:
        args: --follow-symlinks --delete
      env:
        AWS_S3_BUCKET: anjoupleinair.fr
        AWS_ACCESS_KEY_ID: AKIAX3G343OUCKG56Z6K
        AWS_SECRET_ACCESS_KEY: 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
        AWS_REGION: 'eu-west-3'   # optional: defaults to us-east-1
        SOURCE_DIR: 'public'      # optional: defaults to entire repository
        
    - if: github.event.inputs.invalidate_chache == 'true'
      name: Invalidate cache
      uses: awact/cloudfront-action@master
      env:
        SOURCE_PATH: '/'
        AWS_REGION: 'us-east-1'
        AWS_ACCESS_KEY_ID: AKIAX3G343OUCKG56Z6K
        AWS_SECRET_ACCESS_KEY: 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
        DISTRIBUTION_ID: EUOUCGN152D2Y
